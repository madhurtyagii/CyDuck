<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyDuck AI </title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
    <div class="sidebar">
        <button class="new-chat-btn" onclick="newChat()">
            <i class="fas fa-plus"></i> New Chat
        </button>
        <div class="history-list" id="historyList">
            <!-- Sessions will appear here -->
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1><span class="title-text">CyDuck AI</span> <span class="logo-emoji"></span></h1>
        </div>

        <div class="chat-box" id="chatBox">
            <div class="message bot-message message-content">
                Quack!  I'm CyDuck, your intelligent companion. How can I help you today?
            </div>
        </div>

        <div class="typing" id="typingIndicator">CyDuck is thinking...</div>

        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Ask anything..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = 'default';

        // Configure marked for v12+ API
        const renderer = new marked.Renderer();
        renderer.code = function ({ text, lang }) {
            const validLang = lang && hljs.getLanguage(lang) ? lang : 'plaintext';
            const highlighted = hljs.highlight(text, { language: validLang }).value;
            return `
                <div class="code-container">
                    <div class="code-header">
                        <span>${validLang}</span>
                        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    </div>
                    <pre><code class="hljs ${validLang}">${highlighted}</code></pre>
                </div>
            `;
        };

        marked.use({ renderer });
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        function safeParse(text) {
            try {
                return marked.parse(text);
            } catch (e) {
                console.error("Markdown parse error:", e);
                return text.replace(/\n/g, '<br>');
            }
        }

        window.onload = () => {
            loadConversations();
            newChat();
        };

        function copyToClipboard(btn) {
            const code = btn.parentElement.nextElementSibling.querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = btn.innerText;
                btn.innerText = 'Copied!';
                setTimeout(() => btn.innerText = originalText, 2000);
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        async function loadConversations() {
            const res = await fetch('/conversations');
            const data = await res.json();
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            data.forEach(session => {
                const item = document.createElement('div');
                item.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
                item.innerHTML = `
                    <span onclick="switchSession('${session.id}')" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        <i class="far fa-message"></i> ${session.title || 'Untitled'}
                    </span>
                    <div class="history-actions">
                        <button class="action-btn" onclick="renameChat('${session.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="deleteChat('${session.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        async function switchSession(id) {
            currentSessionId = id;
            document.getElementById('chatBox').innerHTML = '';
            document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));

            const res = await fetch(`/conversation/${id}`);
            const messages = await res.json();
            messages.forEach(m => addMessage(m.role, m.content, false));
            loadConversations();
        }

        async function newChat() {
            const res = await fetch('/conversation/new', { method: 'POST' });
            const data = await res.json();
            currentSessionId = data.session_id;
            document.getElementById('chatBox').innerHTML = `
                <div class="message bot-message message-content">
                    Quack!  How can I help you in this new session?
                </div>
            `;
            loadConversations();
        }

        async function deleteChat(id) {
            if (!confirm('Delete this chat?')) return;
            await fetch(`/conversation/${id}`, { method: 'DELETE' });
            if (currentSessionId === id) newChat();
            else loadConversations();
        }

        async function renameChat(id) {
            const newTitle = prompt('Enter new name:');
            if (!newTitle) return;
            await fetch(`/conversation/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle })
            });
            loadConversations();
        }

        function addMessage(role, content, isNew = true) {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'user-message' : 'bot-message message-content'}`;

            if (role === 'assistant') {
                div.innerHTML = safeParse(content);
            } else {
                div.textContent = content;
            }

            chatBox.appendChild(div);
            if (isNew) chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            addMessage('user', message);

            const botMsgDiv = addMessage('assistant', '');
            document.getElementById('typingIndicator').style.display = 'block';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, session_id: currentSessionId })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                if (data.content) {
                                    fullText += data.content;
                                    botMsgDiv.innerHTML = safeParse(fullText);
                                    document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
                                }
                                if (data.new_title) {
                                    loadConversations(); // Refresh sidebar to show new title
                                }
                            } catch (e) { }
                        }
                    });
                }
            } catch (error) {
                botMsgDiv.textContent = "Error connecting to server.";
            } finally {
                document.getElementById('typingIndicator').style.display = 'none';
            }
        }
    </script>
</body>

</html>